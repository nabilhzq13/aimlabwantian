<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D FPS Game</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #111;
        }
        canvas {
            display: block;
        }
        #instructions {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            background-color: rgba(0,0,0,0.7);
            cursor: pointer;
            z-index: 10;
        }
        #instructions h1 {
            font-size: 3em;
            margin-bottom: 0.25em;
        }
        #instructions p {
            font-size: 1.2em;
            margin: 0.5em 0;
        }
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            mix-blend-mode: difference;
            pointer-events: none;
            z-index: 5;
        }
        #score {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        #timer {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div id="instructions">
        <h1>Simple FPS Game</h1>
        <p><strong>Click to start</strong></p>
        <p>Use <strong>WASD</strong> to move</p>
        <p>Use <strong>Mouse</strong> to look around</p>
        <p><strong>Click</strong> to shoot</p>
        <p>Press <strong>ESC</strong> to release mouse</p>
    </div>

    <div id="crosshair"></div>
    <div id="score">Score: 0</div>
    <div id="timer">1:00</div>

    <!-- Import maps for Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/"
            }
        }
    </script>

    <!-- Main Game Logic -->
    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- SCENE SETUP ---
        let scene, camera, renderer, controls;
        let clock;
        const objects = []; // For collision detection
        const bullets = [];
        let score = 0;
        const scoreElement = document.getElementById('score');
        let gun, muzzleFlash;
        let timerElement;
        let gameDuration = 60; // 60 seconds
        let gameEndTime;
        let isGameOver = false;

        const keys = {
            'w': false,
            'a': false,
            's': false,
            'd': false
        };

        const player = {
            velocity: new THREE.Vector3(),
            direction: new THREE.Vector3(),
            speed: 45.0, // Increased speed by 1.5x
        };

        init();
        animate();

        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb); // Light blue sky background
            scene.fog = new THREE.Fog(0x87ceeb, 0, 500); // Sky-colored fog

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 10;
            scene.add(camera); // Add camera to scene to attach gun to it

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6); // Reverted brightness
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0); // Reverted brightness
            directionalLight.position.set(50, 50, 50); 
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // Ground
            const groundGeometry = new THREE.PlaneGeometry(1000, 1000);
            const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x228B22 }); // Forest green
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);


            // Create Gun Model
            gun = new THREE.Group();
            const gunMaterial = new THREE.MeshStandardMaterial({ color: 0x333333 });
            
            const mainBodyGeo = new THREE.BoxGeometry(0.2, 0.3, 1);
            const mainBody = new THREE.Mesh(mainBodyGeo, gunMaterial);
            gun.add(mainBody);

            const handleGeo = new THREE.BoxGeometry(0.2, 0.5, 0.2);
            const handle = new THREE.Mesh(handleGeo, gunMaterial);
            handle.position.set(0, -0.3, 0.2);
            handle.rotation.x = THREE.MathUtils.degToRad(10);
            gun.add(handle);
            
            gun.position.set(0.6, -0.4, -1);
            gun.rotation.y = THREE.MathUtils.degToRad(180);

            camera.add(gun);

            // Muzzle Flash
            muzzleFlash = new THREE.PointLight(0xfff000, 0, 10);
            muzzleFlash.position.set(0.6, -0.25, -1.5);
            camera.add(muzzleFlash);

            // Targets
            const boxGeometry = new THREE.BoxGeometry(5, 5, 5);
            const numTargets = 50;
            const numMovingTargets = 25;

            for (let i = 0; i < numTargets; i++) {
                const boxMaterial = new THREE.MeshStandardMaterial({ color: Math.random() * 0xffffff });
                const box = new THREE.Mesh(boxGeometry, boxMaterial);
                box.position.x = Math.random() * 400 - 200;
                box.position.y = Math.random() * 50 + 5;
                box.position.z = Math.random() * 400 - 200;
                box.castShadow = true;
                box.receiveShadow = true;
                box.userData.isTarget = true;
                
                // Make the first half of the targets move
                if (i < numMovingTargets) {
                    box.userData.velocity = new THREE.Vector3(
                        (Math.random() - 0.5) * 25,
                        (Math.random() - 0.5) * 25,
                        (Math.random() - 0.5) * 25
                    );
                } else {
                    box.userData.velocity = new THREE.Vector3(0, 0, 0); // Static target
                }
                
                scene.add(box);
                objects.push(box);
            }
            
            // Controls
            setupControls();

            // Timer element
            timerElement = document.getElementById('timer');

            // Clock for delta time
            clock = new THREE.Clock();

            // Event Listeners
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            window.addEventListener('click', shoot);
        }

        function setupControls() {
            controls = new PointerLockControls(camera, document.body);

            const instructions = document.getElementById('instructions');
            instructions.addEventListener('click', () => {
                controls.lock();
            });

            controls.addEventListener('lock', () => {
                instructions.style.display = 'none';
                if (isGameOver) return; // Don't restart timer if game ended
                gameEndTime = Date.now() + gameDuration * 1000;
            });

            controls.addEventListener('unlock', () => {
                if (!isGameOver) { // Only show normal instructions if game isn't over
                    instructions.style.display = 'flex';
                }
            });
        }
        
        function shoot() {
            if (!controls.isLocked || isGameOver) return;

            // Muzzle flash effect
            muzzleFlash.intensity = 100;
            setTimeout(() => {
                muzzleFlash.intensity = 0;
            }, 75);

            const bulletGeometry = new THREE.SphereGeometry(0.2, 8, 8);
            const bulletMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
            const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);
            
            const cameraDirection = new THREE.Vector3();
            camera.getWorldDirection(cameraDirection);

            const playerPosition = new THREE.Vector3();
            camera.getWorldPosition(playerPosition);

            bullet.position.copy(playerPosition);
            bullet.velocity = cameraDirection.multiplyScalar(150);
            
            bullets.push(bullet);
            scene.add(bullet);
        }

        function onKeyDown(event) {
            if(keys[event.key.toLowerCase()] !== undefined) {
                keys[event.key.toLowerCase()] = true;
            }
        }

        function onKeyUp(event) {
            if(keys[event.key.toLowerCase()] !== undefined) {
                keys[event.key.toLowerCase()] = false;
            }
        }
        
        function updatePlayer(delta) {
            if (!controls.isLocked || isGameOver) return;

            player.velocity.x -= player.velocity.x * 10.0 * delta;
            player.velocity.z -= player.velocity.z * 10.0 * delta;
            
            player.direction.z = Number(keys['w']) - Number(keys['s']);
            player.direction.x = Number(keys['d']) - Number(keys['a']);
            player.direction.normalize();

            if (keys['w'] || keys['s']) player.velocity.z -= player.direction.z * player.speed * delta;
            if (keys['a'] || keys['d']) player.velocity.x -= player.direction.x * player.speed * delta;
            
            controls.getObject().translateX(-player.velocity.x * delta);
            controls.getObject().translateZ(-player.velocity.z * delta);
        }

        function updateTargets(delta) {
            const playArea = { x: 200, y: 100, z: 200 };

            for (const target of objects) {
                if (target.userData.isTarget && target.userData.velocity.length() > 0) {
                    target.position.add(target.userData.velocity.clone().multiplyScalar(delta));

                    // Bounce off invisible walls in the open field
                    if (Math.abs(target.position.x) > playArea.x) {
                        target.userData.velocity.x *= -1;
                    }
                    if (target.position.y > playArea.y || target.position.y < 2.5) {
                        target.userData.velocity.y *= -1;
                        target.position.y = Math.max(target.position.y, 2.5); // Prevent going through floor
                    }
                    if (Math.abs(target.position.z) > playArea.z) {
                        target.userData.velocity.z *= -1;
                    }
                }
            }
        }

        function updateBullets(delta) {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.position.add(bullet.velocity.clone().multiplyScalar(delta));

                // Remove bullet if it's too far
                if (bullet.position.length() > 1000) {
                    scene.remove(bullet);
                    bullets.splice(i, 1);
                    continue;
                }
                
                // Check for collisions with targets
                for (let j = objects.length - 1; j >= 0; j--) {
                    const target = objects[j];
                    if (target.userData.isTarget && bullet.position.distanceTo(target.position) < 3.5) { 
                        scene.remove(target);
                        objects.splice(j, 1);

                        scene.remove(bullet);
                        bullets.splice(i, 1);

                        score++;
                        scoreElement.textContent = `Score: ${score}`;
                        
                        break; 
                    }
                }
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function updateTimer() {
            if (!controls.isLocked || isGameOver || !gameEndTime) return;

            const remaining = Math.max(0, gameEndTime - Date.now());
            const seconds = Math.floor((remaining / 1000) % 60).toString().padStart(2, '0');
            const minutes = Math.floor(remaining / (1000 * 60)).toString();

            timerElement.textContent = `${minutes}:${seconds}`;

            if (remaining === 0) {
                gameOver();
            }
        }

        function gameOver() {
            isGameOver = true;
            controls.unlock();
            const instructions = document.getElementById('instructions');
            instructions.querySelector('h1').textContent = "Time's Up!";
            
            const paragraphs = instructions.querySelectorAll('p');
            paragraphs[0].innerHTML = `<strong>Your Final Score: ${score}</strong>`;
            paragraphs[1].textContent = "Refresh the page to play again.";
            paragraphs[2].style.display = 'none';
            paragraphs[3].style.display = 'none';
            paragraphs[4].style.display = 'none';
            
            instructions.style.cursor = 'default';
            instructions.style.display = 'flex';
        }

        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();
            
            if (!isGameOver) {
                updatePlayer(delta);
                updateBullets(delta);
                updateTargets(delta);
                updateTimer();
            }

            renderer.render(scene, camera);
        }

    </script>
</body>
</html>


